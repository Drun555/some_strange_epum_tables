Постарался достаточно хорошо комментировать всё это безобразие. 
